@model systeme_gestion_isga.Features.Module.ViewModels.ModuleVM

@{
    ViewBag.Title = "Create a Module";
}

<div class="container-fluid p-4">
    <div class="d-flex align-content-center justify-content-between mb-5">
        <h4 class="fw-bold text-white mb-0">Create A Module</h4>
        <a href='@Url.Action("Index")' class="btn btn-outline-light">
            <i data-lucide="arrow-left"></i>
            Back
        </a>
    </div>

    <div class="card border bg-body-tertiary">
        <div class="card-body p-4">
            @using (Html.BeginForm("Create", "Module", FormMethod.Post, new { @class = "row g-3" }))
            {
                @Html.AntiForgeryToken()

                <div class="col-md-6">
                    <label class="form-label text-white">Name</label>
                    @Html.TextBoxFor(m => m.Name, new { @class = "form-control", placeholder = "Module name..." })
                    @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger small" })
                </div>

                <div class="col-md-6">
                    <label class="form-label text-white">Code</label>
                    @Html.TextBoxFor(m => m.Code, new { @class = "form-control", placeholder = "M101..." })
                    @Html.ValidationMessageFor(m => m.Code, "", new { @class = "text-danger small" })
                </div>

                <div class="col-12">
                    <label class="form-label text-white">Subjects</label>

                    <div class="d-flex gap-2 align-items-start flex-wrap">
                        <select id="subjectPicker" class="form-select" style="max-width: 420px;">
                            <option value="">-- Select a subject to add --</option>
                            @foreach (var s in Model.AvailableSubjects)
                            {
                                <option value="@s.Id">@s.Name</option>
                            }
                        </select>

                        <button type="button" id="btnAddSubject" class="btn btn-outline-light">
                            <i data-lucide="plus"></i>
                            Add
                        </button>
                    </div>

                    <div class="mt-3" id="selectedSubjectsContainer">
                        <!-- JS will render badges + hidden inputs here -->
                    </div>

                    <small class="text-secondary">
                        Pick a subject then click Add. You can remove subjects before saving.
                    </small>
                </div>


                <div class="col-12 d-flex gap-2 mt-5 justify-content-end">
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i data-lucide="x"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-light">
                        <i data-lucide="save"></i>
                        Save
                    </button>
                </div>
            }
        </div>
    </div>
</div>
<script>
    (function () {
        const picker = document.getElementById("subjectPicker");
        const addBtn = document.getElementById("btnAddSubject");
        const container = document.getElementById("selectedSubjectsContainer");

        // Save the original options (except the placeholder)
        const allOptions = Array.from(picker.querySelectorAll("option"))
            .filter(o => o.value !== "")
            .map(o => ({ value: o.value, text: o.text }));

        // store selected items: { subjectId, text }
        let selected = [];

        function rebuildPicker() {
            const selectedIds = new Set(selected.map(x => x.subjectId));

            // Keep placeholder
            picker.innerHTML = `<option value="">-- Select a subject to add --</option>`;

            // Add only options not selected
            allOptions
                .filter(opt => !selectedIds.has(opt.value))
                .forEach(opt => {
                    const option = document.createElement("option");
                    option.value = opt.value;
                    option.textContent = opt.text;
                    picker.appendChild(option);
                });

            picker.value = "";
        }

        function renderSelected() {
            container.innerHTML = "";

            if (selected.length === 0) {
                container.innerHTML = `<div class="text-secondary small">No subjects selected yet.</div>`;
                return;
            }

            selected.forEach((item, index) => {
                const row = document.createElement("div");
                row.className = "d-flex align-items-center gap-2 mb-2 flex-wrap";

                // Chip / badge
                const badge = document.createElement("span");
                badge.className = "badge bg-light text-dark";
                badge.textContent = item.text;

                // Remove button
                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "btn btn-sm btn-outline-danger";
                removeBtn.innerHTML = `<i data-lucide="x"></i>`;
                removeBtn.addEventListener("click", () => {
                    selected = selected.filter(x => x.subjectId !== item.subjectId);
                    render(); // also rebuilds select so it comes back
                });

                // Hidden input for MVC binding: ModuleSubjects[index].SubjectId
                const hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = `ModuleSubjects[${index}].SubjectId`;
                hidden.value = item.subjectId;

                row.appendChild(badge);
                row.appendChild(removeBtn);
                row.appendChild(hidden);

                container.appendChild(row);
            });

            // re-render lucide icons inside newly added buttons
            if (window.lucide) lucide.createIcons();
        }

        function render() {
            rebuildPicker();
            renderSelected();
        }

        addBtn.addEventListener("click", () => {
            const subjectId = picker.value;
            if (!subjectId) return;

            // No duplicates (extra safety)
            if (selected.some(x => x.subjectId === subjectId)) {
                picker.value = "";
                return;
            }

            const text = picker.options[picker.selectedIndex].text;
            selected.push({ subjectId, text });

            render();
        });

        picker.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                addBtn.click();
            }
        });

        render();
    })();
</script>
