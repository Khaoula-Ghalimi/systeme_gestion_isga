@model systeme_gestion_isga.Features.Module.ViewModels.ModuleVM

@{
    ViewBag.Title = "Edit Module";
}

<div class="container-fluid p-4">
    <div class="d-flex align-content-center justify-content-between mb-5">
        <h4 class="fw-bold text-white mb-0">Edit Module : #@Model.Id</h4>
        <a href='@Url.Action("Index")' class="btn btn-outline-light">
            <i data-lucide="arrow-left"></i>
            Back
        </a>
    </div>

    <div class="card border bg-body-tertiary">
        <div class="card-body p-4">
            @using (Html.BeginForm("Edit", "Module", FormMethod.Post, new { @class = "row g-3" }))
            {
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.Id)

                <div class="col-md-6">
                    <label class="form-label text-white">Name</label>
                    @Html.TextBoxFor(m => m.Name, new { @class = "form-control", placeholder = "Module name..." })
                    @Html.ValidationMessageFor(m => m.Name, "", new { @class = "text-danger small" })
                </div>

                <div class="col-md-6">
                    <label class="form-label text-white">Code</label>
                    @Html.TextBoxFor(m => m.Code, new { @class = "form-control", placeholder = "M101..." })
                    @Html.ValidationMessageFor(m => m.Code, "", new { @class = "text-danger small" })
                </div>

                <!-- SUBJECT PICKER -->
                <div class="col-12">
                    <label class="form-label text-white">Subjects</label>

                    <div class="d-flex gap-2 align-items-start flex-wrap">
                        <select id="subjectPicker" class="form-select" style="max-width: 420px;">
                            <option value="">-- Select a subject to add --</option>
                            @foreach (var s in Model.AvailableSubjects)
                            {
                                <option value="@s.Id">@s.Name</option>
                            }
                        </select>

                        <button type="button" id="btnAddSubject" class="btn btn-outline-light">
                            <i data-lucide="plus"></i>
                            Add
                        </button>
                    </div>

                    <!-- preload existing subjects -->
                    <div id="preloadedSubjects" style="display:none;">
                        @for (int i = 0; i < Model.ModuleSubjects.Count; i++)
                        {
                            <div data-id="@Model.ModuleSubjects[i].SubjectId"
                                 data-text="@($"{Model.ModuleSubjects[i].SubjectCode} : {Model.ModuleSubjects[i].SubjectName}")">
                            </div>
                        }
                    </div>

                    <div class="mt-3" id="selectedSubjectsContainer"></div>

                    <small class="text-secondary">
                        Add or remove subjects, then click Save Changes.
                    </small>
                </div>

                <div class="col-12 d-flex gap-2 mt-5 justify-content-end">
                    <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                        <i data-lucide="x"></i>
                        Cancel
                    </a>
                    <button type="submit" class="btn btn-light">
                        <i data-lucide="save"></i>
                        Save Changes
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<script>
    (function () {
        const picker = document.getElementById("subjectPicker");
        const addBtn = document.getElementById("btnAddSubject");
        const container = document.getElementById("selectedSubjectsContainer");

        const allOptions = Array.from(picker.querySelectorAll("option"))
            .filter(o => o.value !== "")
            .map(o => ({ value: o.value, text: o.text }));

        // Load preselected subjects
        let selected = Array.from(document.querySelectorAll("#preloadedSubjects div"))
            .map(d => ({
                subjectId: d.dataset.id,
                text: d.dataset.text
            }));

        function rebuildPicker() {
            const selectedIds = new Set(selected.map(x => x.subjectId));

            picker.innerHTML = `<option value="">-- Select a subject to add --</option>`;

            allOptions
                .filter(opt => !selectedIds.has(opt.value))
                .forEach(opt => {
                    const option = document.createElement("option");
                    option.value = opt.value;
                    option.textContent = opt.text;
                    picker.appendChild(option);
                });

            picker.value = "";
        }

        function renderSelected() {
            container.innerHTML = "";

            if (selected.length === 0) {
                container.innerHTML = `<div class="text-secondary small">No subjects selected yet.</div>`;
                return;
            }

            selected.forEach((item, index) => {
                const row = document.createElement("div");
                row.className = "d-flex align-items-center gap-2 mb-2 flex-wrap";

                const badge = document.createElement("span");
                badge.className = "badge bg-light text-dark";
                badge.textContent = item.text;

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "btn btn-sm btn-outline-danger";
                removeBtn.innerHTML = `<i data-lucide="x"></i>`;
                removeBtn.onclick = () => {
                    selected = selected.filter(x => x.subjectId !== item.subjectId);
                    render();
                };

                const hidden = document.createElement("input");
                hidden.type = "hidden";
                hidden.name = `ModuleSubjects[${index}].SubjectId`;
                hidden.value = item.subjectId;

                row.appendChild(badge);
                row.appendChild(removeBtn);
                row.appendChild(hidden);
                container.appendChild(row);
            });

            if (window.lucide) lucide.createIcons();
        }

        function render() {
            rebuildPicker();
            renderSelected();
        }

        addBtn.onclick = () => {
            const subjectId = picker.value;
            if (!subjectId) return;

            if (selected.some(x => x.subjectId === subjectId)) return;

            const text = picker.options[picker.selectedIndex].text;
            selected.push({ subjectId, text });

            render();
        };

        render();
    })();
</script>
